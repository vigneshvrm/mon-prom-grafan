---
# Production-Grade Prometheus Setup in Podman
# Creates and manages Prometheus container with production best practices

- name: Setup Prometheus in Podman Container (Production)
  hosts: localhost
  gather_facts: true
  become: true
  connection: local

  vars:
    prometheus_version: "latest"  # Can be pinned like "v2.48.0"
    prometheus_image: "docker.io/prom/prometheus:{{ prometheus_version }}"
    prometheus_container_name: "prometheus"
    prometheus_port: 9090
    prometheus_config_dir: "{{ playbook_dir }}/../prometheus-config"
    prometheus_data_dir: "{{ playbook_dir }}/../prometheus-data"
    prometheus_retention: "30d"  # Data retention period
    prometheus_scrape_interval: "15s"
    prometheus_evaluation_interval: "15s"
    prometheus_storage_tsdb_retention_size: "10GB"  # Max storage size
    prometheus_storage_tsdb_retention_time: "{{ prometheus_retention }}"
    prometheus_max_concurrency: 20  # Max concurrent queries
    prometheus_timeout_offset: "10s"
    enable_web_lifecycle: true  # Enable /-/reload endpoint
    enable_web_enable_admin_api: false  # Disable admin API for security
    container_restart_policy: "unless-stopped"
    container_network_mode: "bridge"  # bridge, host, slirp4netns
    container_user: "nobody"  # Run as non-root user
    container_memory_limit: "2G"  # Memory limit
    container_cpu_limit: "2.0"  # CPU limit (cores)
    enable_prometheus_ui: true

  tasks:
    - name: Verify Podman is installed
      command: podman --version
      register: podman_version_check
      changed_when: false
      failed_when: false

    - name: Fail if Podman is not installed
      fail:
        msg: "Podman is not installed. Please run install-podman.yml playbook first."
      when: podman_version_check.rc != 0

    - name: Display Podman version
      debug:
        msg: "Podman version: {{ podman_version_check.stdout }}"

    # Create necessary directories
    - name: Create Prometheus configuration directory
      file:
        path: "{{ prometheus_config_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user | default('root') }}"
        group: "{{ ansible_user | default('root') }}"

    - name: Create Prometheus data directory
      file:
        path: "{{ prometheus_data_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user | default('root') }}"
        group: "{{ ansible_user | default('root') }}"

    # Check if container already exists
    - name: Check if Prometheus container exists
      command: podman ps -a --format "{{ '{{' }}.Names{{ '}}' }}" --filter "name={{ prometheus_container_name }}"
      register: container_exists_check
      changed_when: false
      failed_when: false

    - name: Check if Prometheus container is running
      command: podman ps --format "{{ '{{' }}.Names{{ '}}' }}" --filter "name={{ prometheus_container_name }}" --filter "status=running"
      register: container_running_check
      changed_when: false
      failed_when: false

    - name: Display container status
      debug:
        msg: "Prometheus container status: {{ 'Running' if container_running_check.stdout == prometheus_container_name else 'Not running' }}"
      when: container_exists_check.stdout == prometheus_container_name

    # Create production-grade Prometheus configuration
    - name: Create production Prometheus configuration
      template:
        src: prometheus.yml.j2
        dest: "{{ prometheus_config_dir }}/prometheus.yml"
        mode: '0644'
        backup: yes
      notify: reload prometheus

    # Pull Prometheus image
    - name: Pull Prometheus image
      command: podman pull "{{ prometheus_image }}"
      register: image_pull_result
      changed_when: true
      when: container_exists_check.stdout != prometheus_container_name

    - name: Display image pull status
      debug:
        msg: "Prometheus image: {{ 'Pulled successfully' if image_pull_result.rc == 0 else 'Pull failed' }}"
      when: image_pull_result is defined

    # Stop existing container if running
    - name: Stop existing Prometheus container
      command: podman stop "{{ prometheus_container_name }}"
      register: stop_result
      changed_when: stop_result.rc == 0
      failed_when: false
      when: container_running_check.stdout == prometheus_container_name

    # Remove existing container if it exists
    - name: Remove existing Prometheus container
      command: podman rm "{{ prometheus_container_name }}"
      register: remove_result
      changed_when: remove_result.rc == 0
      failed_when: false
      when: container_exists_check.stdout == prometheus_container_name and container_running_check.stdout != prometheus_container_name

    # Create and start Prometheus container with production settings
    - name: Create and start Prometheus container (Production)
      command: >
        podman run -d
        --name {{ prometheus_container_name }}
        --restart={{ container_restart_policy }}
        --network={{ container_network_mode }}
        --user={{ container_user }}
        --memory={{ container_memory_limit }}
        --cpus={{ container_cpu_limit }}
        -p {{ prometheus_port }}:9090
        -v {{ prometheus_config_dir }}:/etc/prometheus:Z,ro
        -v {{ prometheus_data_dir }}:/prometheus:Z
        --label "app=prometheus"
        --label "version={{ prometheus_version }}"
        --label "managed-by=ansible"
        --health-cmd="wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1"
        --health-interval=30s
        --health-timeout=10s
        --health-retries=3
        --health-start-period=40s
        {{ prometheus_image }}
        --config.file=/etc/prometheus/prometheus.yml
        --storage.tsdb.path=/prometheus
        --storage.tsdb.retention.time={{ prometheus_storage_tsdb_retention_time }}
        --storage.tsdb.retention.size={{ prometheus_storage_tsdb_retention_size }}
        --storage.tsdb.max-block-duration=2h
        --storage.tsdb.min-block-duration=2h
        --web.console.libraries=/usr/share/prometheus/console_libraries
        --web.console.templates=/usr/share/prometheus/consoles
        --web.enable-lifecycle={{ enable_web_lifecycle | lower }}
        --web.enable-admin-api={{ enable_web_enable_admin_api | lower }}
        --web.max-connections=512
        --query.max-concurrency={{ prometheus_max_concurrency }}
        --query.timeout=2m
        --query.max-samples=50000000
        --query.lookback-delta=5m
        --rules.alert.for-outage-tolerance=1h
        --rules.alert.for-grace-period=10m
        --rules.alert.resend-delay=1m
      register: container_create_result
      changed_when: container_create_result.rc == 0
      when: container_exists_check.stdout != prometheus_container_name

    - name: Start existing Prometheus container
      command: podman start "{{ prometheus_container_name }}"
      register: container_start_result
      changed_when: container_start_result.rc == 0
      when: container_exists_check.stdout == prometheus_container_name and container_running_check.stdout != prometheus_container_name

    # Wait for Prometheus to be healthy
    - name: Wait for Prometheus to be healthy
      uri:
        url: "http://localhost:{{ prometheus_port }}/-/healthy"
        method: GET
        status_code: 200
        timeout: 5
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2
      ignore_errors: true

    - name: Verify Prometheus health
      debug:
        msg: "Prometheus health check: {{ 'HEALTHY' if health_check.status == 200 else 'UNHEALTHY - Check logs with: podman logs {{ prometheus_container_name }}' }}"
      when: health_check is defined

    # Check Prometheus readiness
    - name: Check Prometheus readiness
      uri:
        url: "http://localhost:{{ prometheus_port }}/-/ready"
        method: GET
        status_code: 200
        timeout: 5
      register: readiness_check
      retries: 10
      delay: 3
      ignore_errors: true

    - name: Verify Prometheus readiness
      debug:
        msg: "Prometheus readiness: {{ 'READY' if readiness_check.status == 200 else 'NOT READY' }}"
      when: readiness_check is defined

    # Get container information
    - name: Get Prometheus container information
      command: podman inspect "{{ prometheus_container_name }}"
      register: container_info
      changed_when: false
      failed_when: false

    - name: Display Prometheus container status
      debug:
        msg:
          - "=========================================="
          - "Prometheus Container Status:"
          - "=========================================="
          - "Container Name: {{ prometheus_container_name }}"
          - "Image: {{ prometheus_image }}"
          - "Status: {{ 'Running' if container_running_check.stdout == prometheus_container_name else 'Stopped' }}"
          - "Port: {{ prometheus_port }}"
          - "Health: {{ 'Healthy' if health_check.status == 200 else 'Unhealthy' }}"
          - "Readiness: {{ 'Ready' if readiness_check.status == 200 else 'Not Ready' }}"
          - "Access URL: http://localhost:{{ prometheus_port }}"
          - "Config Directory: {{ prometheus_config_dir }}"
          - "Data Directory: {{ prometheus_data_dir }}"
          - "=========================================="

    # Create systemd service for container (optional, for better management)
    - name: Create systemd service for Prometheus container
      template:
        src: prometheus-podman.service.j2
        dest: /etc/systemd/system/prometheus-podman.service
        mode: '0644'
        backup: yes
      notify: reload systemd

    - name: Enable and start Prometheus systemd service
      systemd:
        name: prometheus-podman.service
        enabled: true
        state: started
        daemon_reload: true
      when: ansible_facts['service_mgr'] == 'systemd'
      ignore_errors: true

    # Configure firewall (if needed)
    - name: Configure firewall for Prometheus (firewalld)
      firewalld:
        port: "{{ prometheus_port }}/tcp"
        permanent: true
        state: enabled
        immediate: true
      when: ansible_facts['os_family'] in ['RedHat', 'Suse'] and ansible_facts.get('service_mgr') == 'systemd'
      ignore_errors: true

    - name: Configure firewall for Prometheus (ufw)
      ufw:
        rule: allow
        port: "{{ prometheus_port }}"
        proto: tcp
      when: ansible_facts['os_family'] == 'Debian'
      ignore_errors: true

  handlers:
    - name: reload prometheus
      uri:
        url: "http://localhost:{{ prometheus_port }}/-/reload"
        method: POST
        status_code: 200
        timeout: 5
      failed_when: false
      ignore_errors: true
      when: container_running_check.stdout == prometheus_container_name

    - name: reload systemd
      systemd:
        daemon_reload: true

