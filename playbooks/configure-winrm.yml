---
- name: Configure WinRM for Ansible
  hosts: windows
  gather_facts: false
  become: false

  tasks:
    - name: Test WinRM connectivity first
      win_ping:
      register: winrm_ping_test
      ignore_errors: true
      failed_when: false
      vars:
        ansible_winrm_connection_timeout: 10
      # Note: win_ping uses WinRM protocol, NOT ICMP ping
      # ICMP being disabled on Windows servers does NOT affect WinRM connectivity

    - name: Check if authentication failed
      set_fact:
        winrm_auth_failed: true
        winrm_error_type: "authentication"
        winrm_error_msg: "{{ winrm_ping_test.msg | default('Credentials rejected') }}"
      when: 
        - (winrm_ping_test is failed or winrm_ping_test is unreachable)
        - winrm_ping_test.msg is defined
        - "'credentials' in (winrm_ping_test.msg | lower)"
        - "'rejected' in (winrm_ping_test.msg | lower)"

    - name: Check if connection timeout/unreachable
      set_fact:
        winrm_unreachable: true
        winrm_error_type: "connection"
        winrm_error_msg: "{{ winrm_ping_test.msg | default('Connection timeout') }}"
      when:
        - winrm_ping_test is failed or winrm_ping_test is unreachable
        - winrm_auth_failed | default(false) == false

    - name: Skip configuration if WinRM is already accessible
      debug:
        msg: "WinRM is already configured and accessible. Skipping WinRM configuration playbook."
      when: winrm_ping_test is succeeded

    - name: End play if WinRM is already working
      meta: end_play
      when: winrm_ping_test is succeeded

    - name: Check if WinRM is already configured
      win_shell: |
        $winrm = Get-Service -Name WinRM -ErrorAction SilentlyContinue
        if ($winrm -and $winrm.Status -eq 'Running') {
          $listener = Get-WSManInstance -ResourceURI winrm/config/Listener -Enumerate -ErrorAction SilentlyContinue
          if ($listener) {
            Write-Output "configured"
          } else {
            Write-Output "not_configured"
          }
        } else {
          Write-Output "not_running"
        }
      register: winrm_status
      changed_when: false
      when: winrm_ping_test is succeeded

    - name: Handle WinRM unreachable case (if not already set)
      set_fact:
        winrm_unreachable: true
        winrm_status_normalized: "unreachable"
      when: 
        - (winrm_ping_test is failed or winrm_ping_test is unreachable)
        - winrm_unreachable is not defined
        - winrm_auth_failed | default(false) == false

    - name: Normalize WinRM status
      set_fact:
        winrm_status_normalized: "{{ winrm_status.stdout | default('') | trim | lower }}"
      when: winrm_ping_test is succeeded and winrm_status is defined

    - name: Enable WinRM service
      win_service:
        name: WinRM
        start_mode: auto
        state: started
      when: winrm_status_normalized != "configured"

    - name: Configure WinRM for HTTP (Basic Auth)
      win_shell: |
        # Remove existing HTTP listener if any
        Remove-WSManInstance -ResourceURI winrm/config/Listener -SelectorSet @{Address="*";Transport="HTTP"} -ErrorAction SilentlyContinue
        
        # Create new HTTP listener
        New-WSManInstance -ResourceURI winrm/config/Listener -SelectorSet @{Address="*";Transport="HTTP"} -ValueSet @{Hostname="*"}
        
        # Configure WinRM service
        Set-Item WSMan:\localhost\Service\Auth\Basic -Value $true
        Set-Item WSMan:\localhost\Service\AllowUnencrypted -Value $true
        
        # Configure WinRM client
        Set-Item WSMan:\localhost\Client\Auth\Basic -Value $true
        Set-Item WSMan:\localhost\Client\AllowUnencrypted -Value $true
        
        # Restart WinRM service
        Restart-Service WinRM -Force
        
        Write-Output "WinRM configured successfully"
      when: winrm_status_normalized != "configured"
      register: winrm_config_result

    - name: Ensure Windows Firewall allows WinRM (always check)
      win_firewall_rule:
        name: "WinRM HTTP"
        localport: 5985
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes

    - name: Verify WinRM is accessible (after configuration)
      win_wait_for:
        port: 5985
        timeout: 30
        delay: 5
      when: winrm_status_normalized != "configured"
      ignore_errors: true

    - name: Test WinRM connectivity (always verify)
      win_ping:
      register: winrm_ping_result
      ignore_errors: true

    - name: Display WinRM authentication error with instructions
      fail:
        msg: |
          ============================================
          WinRM Authentication Failed
          ============================================
          
          The credentials work for RDP but are rejected by WinRM on {{ inventory_hostname }}.
          Follow the official Ansible WinRM setup guide to configure WinRM properly.
          
          **Run this PowerShell script on the Windows host (as Administrator):**
          
          # Complete WinRM setup (from Ansible documentation)
          # Enables the WinRM service and sets up the HTTP listener
          Enable-PSRemoting -Force
          
          # Opens port 5985 for all profiles
          $firewallParams = @{
              Action      = 'Allow'
              Description = 'Inbound rule for Windows Remote Management via WS-Management. [TCP 5985]'
              Direction   = 'Inbound'
              DisplayName = 'Windows Remote Management (HTTP-In)'
              LocalPort   = 5985
              Profile     = 'Any'
              Protocol    = 'TCP'
          }
          New-NetFirewallRule @firewallParams
          
          # Allows local user accounts to be used with WinRM (REQUIRED for local admin)
          $tokenFilterParams = @{
              Path         = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
              Name         = 'LocalAccountTokenFilterPolicy'
              Value        = 1
              PropertyType = 'DWORD'
              Force        = $true
          }
          New-ItemProperty @tokenFilterParams
          
          # Enable Basic Authentication and allow unencrypted (required for Basic over HTTP)
          winrm set winrm/config/service/auth @{Basic="true"}
          winrm set winrm/config/service @{AllowUnencrypted="true"}
          
          # Configure WinRM Client
          winrm set winrm/config/client/auth @{Basic="true"}
          winrm set winrm/config/client @{AllowUnencrypted="true"}
          
          # Restart WinRM service
          Restart-Service WinRM
          
          **Verify the configuration:**
          
          # Check WinRM listener
          winrm enumerate winrm/config/Listener
          
          # Check authentication settings
          winrm get winrm/config/service/auth
          # Should show: Basic = true
          
          # Test WinRM connection locally
          winrs -r:http://localhost:5985/wsman -u:{{ ansible_user }} -p:YOUR_PASSWORD ipconfig
          
          **CRITICAL: Most Common Issue - LocalAccountTokenFilterPolicy**
          
          If you're using a LOCAL Administrator account (not domain), the registry key
          LocalAccountTokenFilterPolicy MUST be set to 1. Without this, local admin
          accounts are rejected by WinRM even with correct credentials.
          
          Verify it's set correctly:
          Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name LocalAccountTokenFilterPolicy
          # Should return: LocalAccountTokenFilterPolicy : 1
          
          If it's missing or 0, run the script above to set it.
          
          **Quick Diagnostic Commands** (run on Windows host):
          
          # Check if Basic Auth is enabled
          winrm get winrm/config/service/auth
          # Look for: Basic = true
          
          # Check LocalAccountTokenFilterPolicy
          Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name LocalAccountTokenFilterPolicy -ErrorAction SilentlyContinue
          
          # Check if AllowUnencrypted is true
          winrm get winrm/config/service
          # Look for: AllowUnencrypted = true
          
          **Important Notes:**
          - LocalAccountTokenFilterPolicy is REQUIRED for local administrator accounts
          - AllowUnencrypted must be true when using Basic auth over HTTP (port 5985)
          - After making changes, wait 10-15 seconds before retrying the Ansible connection
          - If using domain account, ensure account is not locked and has proper permissions
          
          Reference: https://docs.ansible.com/projects/ansible/latest/os_guide/windows_winrm.html
          
          Error: {{ winrm_error_msg | default(winrm_ping_test.msg | default('Unknown error')) }}
      when: winrm_auth_failed | default(false)

    - name: Display WinRM connection error with instructions
      fail:
        msg: |
          ============================================
          WinRM is not accessible on {{ inventory_hostname }}:5985
          ============================================
          
          WinRM must be configured on the Windows host BEFORE Ansible can connect.
          Follow the official Ansible WinRM setup guide.
          
          **Run this PowerShell script on the Windows host (as Administrator):**
          
          # Complete WinRM setup (from Ansible documentation)
          # Enables the WinRM service and sets up the HTTP listener
          Enable-PSRemoting -Force
          
          # Opens port 5985 for all profiles
          $firewallParams = @{
              Action      = 'Allow'
              Description = 'Inbound rule for Windows Remote Management via WS-Management. [TCP 5985]'
              Direction   = 'Inbound'
              DisplayName = 'Windows Remote Management (HTTP-In)'
              LocalPort   = 5985
              Profile     = 'Any'
              Protocol    = 'TCP'
          }
          New-NetFirewallRule @firewallParams
          
          # Allows local user accounts to be used with WinRM (REQUIRED for local admin)
          $tokenFilterParams = @{
              Path         = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
              Name         = 'LocalAccountTokenFilterPolicy'
              Value        = 1
              PropertyType = 'DWORD'
              Force        = $true
          }
          New-ItemProperty @tokenFilterParams
          
          # Enable Basic Authentication and allow unencrypted (required for Basic over HTTP)
          winrm set winrm/config/service/auth @{Basic="true"}
          winrm set winrm/config/service @{AllowUnencrypted="true"}
          
          # Configure WinRM Client
          winrm set winrm/config/client/auth @{Basic="true"}
          winrm set winrm/config/client @{AllowUnencrypted="true"}
          
          # Restart WinRM service
          Restart-Service WinRM
          
          **Verify the configuration:**
          
          # Check WinRM listener
          winrm enumerate winrm/config/Listener
          
          # Test connection from another Windows host (if available)
          winrs -r:http://{{ inventory_hostname }}:5985/wsman -u:{{ ansible_user }} -p:YOUR_PASSWORD ipconfig
          
          **Troubleshooting:**
          - Verify port 5985 is open: Test-NetConnection -ComputerName {{ inventory_hostname }} -Port 5985
          - Check firewall rules: Get-NetFirewallRule -DisplayName "*WinRM*"
          - Verify WinRM service is running: Get-Service WinRM
          - Note: ICMP (ping) is NOT required for WinRM - WinRM uses TCP port 5985
          
          **If you need to enable ICMP for other purposes** (optional, not required for WinRM):
          # Allow ICMP Echo Request (ping) through firewall
          New-NetFirewallRule -DisplayName "ICMP Echo Request" -Direction Inbound -Protocol ICMPv4 -IcmpType 8 -Action Allow
          
          Reference: https://docs.ansible.com/projects/ansible/latest/os_guide/windows_winrm.html
          
          Error details: {{ winrm_error_msg | default(winrm_ping_test.msg | default('Connection timeout')) }}
      when: 
        - winrm_unreachable | default(false)
        - winrm_auth_failed | default(false) == false

    - name: Display WinRM status
      debug:
        msg:
          - "WinRM Status: {{ winrm_status_normalized | default('unknown') }}"
          - "WinRM Connectivity: {{ 'OK' if winrm_ping_result is succeeded else 'FAILED - Check firewall and network connectivity' }}"
          - "WinRM is configured and ready for Ansible connections"
      when: winrm_unreachable | default(false) == false

