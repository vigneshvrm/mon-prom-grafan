---
- name: Configure WinRM for Ansible
  hosts: windows
  gather_facts: false
  become: false

  tasks:
    - name: Test WinRM connectivity first
      win_ping:
      register: winrm_ping_test
      ignore_errors: true
      failed_when: false
      vars:
        ansible_winrm_connection_timeout: 10

    - name: Check if authentication failed
      set_fact:
        winrm_auth_failed: true
        winrm_error_type: "authentication"
        winrm_error_msg: "{{ winrm_ping_test.msg | default('Credentials rejected') }}"
      when: 
        - (winrm_ping_test is failed or winrm_ping_test is unreachable)
        - winrm_ping_test.msg is defined
        - "'credentials' in (winrm_ping_test.msg | lower)"
        - "'rejected' in (winrm_ping_test.msg | lower)"

    - name: Check if connection timeout/unreachable
      set_fact:
        winrm_unreachable: true
        winrm_error_type: "connection"
        winrm_error_msg: "{{ winrm_ping_test.msg | default('Connection timeout') }}"
      when:
        - winrm_ping_test is failed or winrm_ping_test is unreachable
        - winrm_auth_failed | default(false) == false

    - name: Skip configuration if WinRM is already accessible
      debug:
        msg: "WinRM is already configured and accessible. Skipping WinRM configuration playbook."
      when: winrm_ping_test is succeeded

    - name: End play if WinRM is already working
      meta: end_play
      when: winrm_ping_test is succeeded

    - name: Check if WinRM is already configured
      win_shell: |
        $winrm = Get-Service -Name WinRM -ErrorAction SilentlyContinue
        if ($winrm -and $winrm.Status -eq 'Running') {
          $listener = Get-WSManInstance -ResourceURI winrm/config/Listener -Enumerate -ErrorAction SilentlyContinue
          if ($listener) {
            Write-Output "configured"
          } else {
            Write-Output "not_configured"
          }
        } else {
          Write-Output "not_running"
        }
      register: winrm_status
      changed_when: false
      when: winrm_ping_test is succeeded

    - name: Handle WinRM unreachable case (if not already set)
      set_fact:
        winrm_unreachable: true
        winrm_status_normalized: "unreachable"
      when: 
        - (winrm_ping_test is failed or winrm_ping_test is unreachable)
        - winrm_unreachable is not defined
        - winrm_auth_failed | default(false) == false

    - name: Normalize WinRM status
      set_fact:
        winrm_status_normalized: "{{ winrm_status.stdout | default('') | trim | lower }}"
      when: winrm_ping_test is succeeded and winrm_status is defined

    - name: Enable WinRM service
      win_service:
        name: WinRM
        start_mode: auto
        state: started
      when: winrm_status_normalized != "configured"

    - name: Configure WinRM for HTTP (Basic Auth)
      win_shell: |
        # Remove existing HTTP listener if any
        Remove-WSManInstance -ResourceURI winrm/config/Listener -SelectorSet @{Address="*";Transport="HTTP"} -ErrorAction SilentlyContinue
        
        # Create new HTTP listener
        New-WSManInstance -ResourceURI winrm/config/Listener -SelectorSet @{Address="*";Transport="HTTP"} -ValueSet @{Hostname="*"}
        
        # Configure WinRM service
        Set-Item WSMan:\localhost\Service\Auth\Basic -Value $true
        Set-Item WSMan:\localhost\Service\AllowUnencrypted -Value $true
        
        # Configure WinRM client
        Set-Item WSMan:\localhost\Client\Auth\Basic -Value $true
        Set-Item WSMan:\localhost\Client\AllowUnencrypted -Value $true
        
        # Restart WinRM service
        Restart-Service WinRM -Force
        
        Write-Output "WinRM configured successfully"
      when: winrm_status_normalized != "configured"
      register: winrm_config_result

    - name: Ensure Windows Firewall allows WinRM (always check)
      win_firewall_rule:
        name: "WinRM HTTP"
        localport: 5985
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes

    - name: Verify WinRM is accessible (after configuration)
      win_wait_for:
        port: 5985
        timeout: 30
        delay: 5
      when: winrm_status_normalized != "configured"
      ignore_errors: true

    - name: Test WinRM connectivity (always verify)
      win_ping:
      register: winrm_ping_result
      ignore_errors: true

    - name: Display WinRM authentication error with instructions
      fail:
        msg: |
          ============================================
          WinRM Authentication Failed
          ============================================
          
          The credentials provided were rejected by the Windows host ({{ inventory_hostname }}).
          
          Please verify and fix the following:
          
          1. **Check Username and Password**:
             - Ensure the username is correct (e.g., "Administrator" or "DOMAIN\\username")
             - Verify the password is correct
             - Try logging in to the Windows host with these credentials manually
          
          2. **Enable Basic Authentication on Windows Host** (run as Administrator):
             winrm set winrm/config/service/auth @{Basic="true"}
             winrm set winrm/config/service @{AllowUnencrypted="true"}
          
          3. **Configure Local Account for WinRM** (if using local account):
             # For local Administrator account, ensure it's enabled:
             net user Administrator /active:yes
          
          4. **If using Domain Account**, ensure:
             - Domain credentials are correct
             - Account is not locked
             - Account has necessary permissions
          
          5. **Test WinRM connection manually** (from Ansible controller):
             winrm -r:http://{{ inventory_hostname }}:5985/wsman -u:{{ ansible_user }} -p:YOUR_PASSWORD id
          
          After fixing the authentication issue, try the installation again.
          
          Error: {{ winrm_error_msg | default(winrm_ping_test.msg | default('Unknown error')) }}
      when: winrm_auth_failed | default(false)

    - name: Display WinRM connection error with instructions
      fail:
        msg: |
          ============================================
          WinRM is not accessible on {{ inventory_hostname }}:5985
          ============================================
          
          WinRM must be configured on the Windows host BEFORE Ansible can connect.
          
          Please run these commands on the Windows host (as Administrator in PowerShell):
          
          1. Enable WinRM:
             winrm quickconfig -force
          
          2. Configure Basic Authentication:
             winrm set winrm/config/service/auth @{Basic="true"}
             winrm set winrm/config/service @{AllowUnencrypted="true"}
          
          3. Configure WinRM Client:
             winrm set winrm/config/client/auth @{Basic="true"}
             winrm set winrm/config/client @{AllowUnencrypted="true"}
          
          4. Allow WinRM through Windows Firewall:
             netsh advfirewall firewall add rule name="WinRM HTTP" dir=in action=allow protocol=TCP localport=5985
          
          5. Restart WinRM service:
             Restart-Service WinRM
          
          6. Verify WinRM is listening:
             winrm enumerate winrm/config/Listener
          
          After running these commands, try the installation again.
          
          Note: If you're behind a firewall, ensure port 5985 is open between
          the Ansible controller and the Windows host ({{ inventory_hostname }}).
          
          Error details: {{ winrm_error_msg | default(winrm_ping_test.msg | default('Connection timeout')) }}
      when: 
        - winrm_unreachable | default(false)
        - winrm_auth_failed | default(false) == false

    - name: Display WinRM status
      debug:
        msg:
          - "WinRM Status: {{ winrm_status_normalized | default('unknown') }}"
          - "WinRM Connectivity: {{ 'OK' if winrm_ping_result is succeeded else 'FAILED - Check firewall and network connectivity' }}"
          - "WinRM is configured and ready for Ansible connections"
      when: winrm_unreachable | default(false) == false

