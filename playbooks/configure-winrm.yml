---
- name: Configure WinRM for Ansible
  hosts: windows
  gather_facts: false
  become: false

  tasks:
    - name: Check if WinRM is already configured
      win_shell: |
        $winrm = Get-Service -Name WinRM -ErrorAction SilentlyContinue
        if ($winrm -and $winrm.Status -eq 'Running') {
          $listener = Get-WSManInstance -ResourceURI winrm/config/Listener -Enumerate -ErrorAction SilentlyContinue
          if ($listener) {
            Write-Output "configured"
          } else {
            Write-Output "not_configured"
          }
        } else {
          Write-Output "not_running"
        }
      register: winrm_status
      changed_when: false

    - name: Normalize WinRM status
      set_fact:
        winrm_status_normalized: "{{ winrm_status.stdout | default('') | trim | lower }}"

    - name: Enable WinRM service
      win_service:
        name: WinRM
        start_mode: auto
        state: started
      when: winrm_status_normalized != "configured"

    - name: Configure WinRM for HTTP (Basic Auth)
      win_shell: |
        # Remove existing HTTP listener if any
        Remove-WSManInstance -ResourceURI winrm/config/Listener -SelectorSet @{Address="*";Transport="HTTP"} -ErrorAction SilentlyContinue
        
        # Create new HTTP listener
        New-WSManInstance -ResourceURI winrm/config/Listener -SelectorSet @{Address="*";Transport="HTTP"} -ValueSet @{Hostname="*"}
        
        # Configure WinRM service
        Set-Item WSMan:\localhost\Service\Auth\Basic -Value $true
        Set-Item WSMan:\localhost\Service\AllowUnencrypted -Value $true
        
        # Configure WinRM client
        Set-Item WSMan:\localhost\Client\Auth\Basic -Value $true
        Set-Item WSMan:\localhost\Client\AllowUnencrypted -Value $true
        
        # Restart WinRM service
        Restart-Service WinRM -Force
        
        Write-Output "WinRM configured successfully"
      when: winrm_status_normalized != "configured"
      register: winrm_config_result

    - name: Ensure Windows Firewall allows WinRM (always check)
      win_firewall_rule:
        name: "WinRM HTTP"
        localport: 5985
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes

    - name: Verify WinRM is accessible (after configuration)
      win_wait_for:
        port: 5985
        timeout: 30
        delay: 5
      when: winrm_status_normalized != "configured"
      ignore_errors: true

    - name: Test WinRM connectivity (always verify)
      win_ping:
      register: winrm_ping_result
      ignore_errors: true

    - name: Display WinRM status
      debug:
        msg:
          - "WinRM Status: {{ winrm_status_normalized | default(winrm_status.stdout) }}"
          - "WinRM Connectivity: {{ 'OK' if winrm_ping_result is succeeded else 'FAILED - Check firewall and network connectivity' }}"
          - "WinRM is configured and ready for Ansible connections"

