---
# Main orchestration playbook
# Routes to appropriate installation playbook based on OS

- name: Route to Linux or Windows installation
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Normalize and determine target OS
      set_fact:
        target_os_determined: "{{ (target_os | default('linux') | string | lower) }}"
    
    - name: Debug OS determination
      debug:
        msg:
          - "Target OS received: {{ target_os | default('not_set') }}"
          - "Target OS determined: {{ target_os_determined }}"
          - "Will route to: {{ 'Windows' if target_os_determined == 'windows' else 'Linux' }}"

- name: Install Node Exporter on Linux
  import_playbook: linux-node-exporter.yml
  when: target_os_determined != 'windows'

- name: Configure WinRM for Windows (must run before Windows Exporter)
  import_playbook: configure-winrm.yml
  when: target_os_determined == 'windows'

- name: Install Windows Exporter
  import_playbook: windows-node-exporter.yml
  when: target_os_determined == 'windows'
