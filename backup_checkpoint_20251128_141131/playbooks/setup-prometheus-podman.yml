---
# Production-Grade Prometheus Setup in Podman
# Creates and manages Prometheus container with production best practices

- name: Setup Prometheus in Podman Container (Production)
  hosts: localhost
  gather_facts: true
  become: true
  connection: local

  vars:
    prometheus_version: "latest"  # Can be pinned like "v2.48.0"
    prometheus_image: "docker.io/prom/prometheus:{{ prometheus_version }}"
    prometheus_container_name: "prometheus"
    prometheus_port: 9090
    prometheus_config_dir: "/etc/prometheus"  # System-wide configuration directory
    prometheus_retention: "30d"  # Data retention period
    prometheus_scrape_interval: "15s"
    prometheus_evaluation_interval: "15s"
    prometheus_storage_tsdb_retention_size: "10GB"  # Max storage size
    prometheus_storage_tsdb_retention_time: "{{ prometheus_retention }}"
    prometheus_max_concurrency: 20  # Max concurrent queries
    prometheus_timeout_offset: "10s"
    enable_web_lifecycle: true  # Enable /-/reload endpoint
    enable_web_enable_admin_api: false  # Disable admin API for security
    container_restart_policy: "unless-stopped"
    container_network_mode: "bridge"  # bridge, host, slirp4netns
    container_user: "nobody"  # Run as non-root user
    container_memory_limit: "2G"  # Memory limit
    container_cpu_limit: "2.0"  # CPU limit (cores)
    enable_prometheus_ui: true

  tasks:
    # Pre-installation checks: Verify Prometheus is not already installed
    - name: Check if Prometheus is running as systemd service
      command: systemctl is-active prometheus
      register: systemd_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Check if Prometheus container is running
      command: podman ps --format "{{ '{{' }}.Names{{ '}}' }}" --filter "name={{ prometheus_container_name }}" --filter "status=running"
      register: container_running_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Check if Prometheus container exists (stopped)
      command: podman ps -a --format "{{ '{{' }}.Names{{ '}}' }}" --filter "name={{ prometheus_container_name }}"
      register: container_exists_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Set container status variables
      set_fact:
        container_exists: "{{ container_exists_check.stdout == prometheus_container_name }}"
        container_running: "{{ container_running_check.stdout == prometheus_container_name }}"

    - name: Display Prometheus installation status
      debug:
        msg:
          - "Checking existing Prometheus installation..."
          - "Systemd Service: {{ 'Running' if systemd_check.rc == 0 else 'Not running' }}"
          - "Container (Running): {{ 'Running' if container_running else 'Not running' }}"
          - "Container (Exists): {{ 'Exists' if container_exists else 'Does not exist' }}"

    - name: Fail if Prometheus is already installed as systemd service
      fail:
        msg: "Prometheus is already installed and running as a systemd service. Please stop it first or use the existing installation."
      when: systemd_check.rc == 0

    - name: Fail if Prometheus container is already running
      fail:
        msg: "Prometheus container is already running. Use 'podman restart prometheus' or 'podman stop prometheus' to manage it."
      when: container_running

    - name: Verify Podman is installed
      command: podman --version
      register: podman_version_check
      changed_when: false
      failed_when: false

    - name: Fail if Podman is not installed
      fail:
        msg: "Podman is not installed. Please run install-podman.yml playbook first."
      when: podman_version_check.rc != 0

    - name: Display Podman version
      debug:
        msg: "Podman version: {{ podman_version_check.stdout }}"

    # Create necessary directories
    - name: Create Prometheus configuration directory
      file:
        path: "{{ prometheus_config_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root



    # Check if prometheus.yml exists
    - name: Check if prometheus.yml exists
      stat:
        path: "{{ prometheus_config_dir }}/prometheus.yml"
      register: prometheus_config_stat
      changed_when: false

    # Create production-grade Prometheus configuration
    - name: Create production Prometheus configuration
      template:
        src: prometheus.yml.j2
        dest: "{{ prometheus_config_dir }}/prometheus.yml"
        mode: '0644'
        owner: root
        group: root
        backup: yes
      notify: reload prometheus
      when: not prometheus_config_stat.stat.exists

    # Pull Prometheus image
    - name: Pull Prometheus image
      command: podman pull "{{ prometheus_image }}"
      register: image_pull_result
      changed_when: true
      when: not container_exists

    - name: Display image pull status
      debug:
        msg: "Prometheus image: {{ 'Pulled successfully' if image_pull_result.rc == 0 else 'Pull failed' }}"
      when: image_pull_result is defined

    # Note: We don't stop/remove existing containers here because
    # the pre-installation check already prevents installation if container is running

    # Create and start Prometheus container with production settings
    - name: Create and start Prometheus container (Production)
      command: >
        podman run -d
        --name {{ prometheus_container_name }}
        --restart={{ container_restart_policy }}
        -v /etc/hosts:/etc/hosts
        --dns 8.8.8.8
        --dns 1.1.1.1
        -v {{ prometheus_config_dir }}:/etc/prometheus
        -p {{ prometheus_port }}:9090
        --label "app=prometheus"
        --label "version={{ prometheus_version }}"
        --label "managed-by=ansible"
        {{ prometheus_image }}
        --config.file=/etc/prometheus/prometheus.yml
      register: container_create_result
      changed_when: container_create_result.rc == 0
      when: not container_exists

    - name: Start existing Prometheus container (if stopped)
      command: podman start "{{ prometheus_container_name }}"
      register: container_start_result
      changed_when: container_start_result.rc == 0
      when: container_exists and not container_running

    # Wait for Prometheus to be healthy
    - name: Wait for Prometheus to be healthy
      uri:
        url: "http://localhost:{{ prometheus_port }}/-/healthy"
        method: GET
        status_code: 200
        timeout: 5
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2
      ignore_errors: true

    - name: Verify Prometheus health
      debug:
        msg: "Prometheus health check: {{ 'HEALTHY' if health_check.status == 200 else 'UNHEALTHY - Check logs with: podman logs {{ prometheus_container_name }}' }}"
      when: health_check is defined

    # Check Prometheus readiness
    - name: Check Prometheus readiness
      uri:
        url: "http://localhost:{{ prometheus_port }}/-/ready"
        method: GET
        status_code: 200
        timeout: 5
      register: readiness_check
      retries: 10
      delay: 3
      ignore_errors: true

    - name: Verify Prometheus readiness
      debug:
        msg: "Prometheus readiness: {{ 'READY' if readiness_check.status == 200 else 'NOT READY' }}"
      when: readiness_check is defined

    # Get container information
    - name: Get Prometheus container information
      command: podman inspect "{{ prometheus_container_name }}"
      register: container_info
      changed_when: false
      failed_when: false

    - name: Display Prometheus container status
      debug:
        msg:
          - "=========================================="
          - "Prometheus Container Status:"
          - "=========================================="
          - "Container Name: {{ prometheus_container_name }}"
          - "Image: {{ prometheus_image }}"
          - "Status: {{ 'Running' if container_running else 'Stopped' }}"
          - "Port: {{ prometheus_port }}"
          - "Health: {{ 'Healthy' if health_check.status == 200 else 'Unhealthy' }}"
          - "Readiness: {{ 'Ready' if readiness_check.status == 200 else 'Not Ready' }}"
          - "Access URL: http://localhost:{{ prometheus_port }}"
          - "Config Directory: {{ prometheus_config_dir }}"
          - "=========================================="

    # Create systemd service for container using podman generate systemd
    # This generates the service file based on the actual container configuration
    # Note: Container must exist (running or stopped) before generating systemd file
    - name: Verify container exists for systemd service generation
      command: podman ps -a --format "{{ '{{' }}.Names{{ '}}' }}" --filter "name={{ prometheus_container_name }}"
      register: verify_container_exists
      changed_when: false
      failed_when: false
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Display container verification result
      debug:
        msg: "Container verification: {{ 'EXISTS' if verify_container_exists.stdout == prometheus_container_name else 'DOES NOT EXIST' }}"
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - verify_container_exists is defined

    - name: Generate systemd service file for Prometheus container
      command: >
        podman generate systemd
        --name {{ prometheus_container_name }}
        --files
        --new
        --restart-policy=always
      register: generate_systemd_result
      changed_when: generate_systemd_result.rc == 0
      failed_when: false
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - verify_container_exists.stdout == prometheus_container_name
      args:
        chdir: /tmp

    - name: Display systemd generation result
      debug:
        msg: "Systemd generation: {{ 'SUCCESS' if generate_systemd_result.rc == 0 else 'FAILED - ' + generate_systemd_result.stderr | default('Unknown error') }}"
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - generate_systemd_result is defined

    - name: Get generated systemd service filename
      set_fact:
        generated_service_file: "container-{{ prometheus_container_name }}.service"
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - generate_systemd_result is defined
        - generate_systemd_result.rc == 0

    - name: Check if generated service file exists in /tmp
      stat:
        path: "/tmp/{{ generated_service_file }}"
      register: service_file_stat
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - generated_service_file is defined

    - name: Display service file check result
      debug:
        msg: "Service file in /tmp: {{ 'EXISTS' if service_file_stat.stat.exists else 'NOT FOUND' }}"
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - service_file_stat is defined

    - name: Move generated systemd service file to system directory
      copy:
        src: "/tmp/{{ generated_service_file }}"
        dest: "/etc/systemd/system/{{ generated_service_file }}"
        mode: '0644'
        owner: root
        group: root
        remote_src: true
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - generated_service_file is defined
        - service_file_stat.stat.exists | default(false)
      notify: reload systemd

    - name: Verify service file was moved to system directory
      stat:
        path: "/etc/systemd/system/{{ generated_service_file }}"
      register: final_service_file_stat
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - generated_service_file is defined

    - name: Display final service file status
      debug:
        msg: "Service file in /etc/systemd/system/: {{ 'EXISTS' if final_service_file_stat.stat.exists else 'NOT FOUND' }}"
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - final_service_file_stat is defined

    - name: Clean up temporary service file
      file:
        path: "/tmp/{{ generated_service_file }}"
        state: absent
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - generated_service_file is defined
      ignore_errors: true

    - name: Reload systemd daemon
      systemd:
        daemon_reload: true
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - final_service_file_stat.stat.exists | default(false)

    - name: Enable Prometheus systemd service at boot
      systemd:
        name: "{{ generated_service_file }}"
        enabled: true
        daemon_reload: false
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - generated_service_file is defined
        - final_service_file_stat.stat.exists | default(false)
      ignore_errors: true

    - name: Start Prometheus systemd service
      systemd:
        name: "{{ generated_service_file }}"
        state: started
        daemon_reload: false
      when: 
        - ansible_facts['service_mgr'] == 'systemd'
        - generated_service_file is defined
        - final_service_file_stat.stat.exists | default(false)
      ignore_errors: true

    # Configure firewall (if needed)
    - name: Configure firewall for Prometheus (firewalld)
      firewalld:
        port: "{{ prometheus_port }}/tcp"
        permanent: true
        state: enabled
        immediate: true
      when: ansible_facts['os_family'] in ['RedHat', 'Suse'] and ansible_facts.get('service_mgr') == 'systemd'
      ignore_errors: true

    - name: Configure firewall for Prometheus (ufw)
      ufw:
        rule: allow
        port: "{{ prometheus_port }}"
        proto: tcp
      when: ansible_facts['os_family'] == 'Debian'
      ignore_errors: true

  handlers:
    - name: reload prometheus
      uri:
        url: "http://localhost:{{ prometheus_port }}/-/reload"
        method: POST
        status_code: 200
        timeout: 5
      failed_when: false
      ignore_errors: true
      when: container_running

    - name: reload systemd
      systemd:
        daemon_reload: true

